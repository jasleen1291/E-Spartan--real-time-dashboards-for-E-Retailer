<!DOCTYPE html>
<html lang="en">
<head>

  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <title>Home Page</title>
  <!-- Compiled and minified CSS -->

  <!--Import materialize.css-->
  <link type="text/css" rel="stylesheet" href="/stylesheets/materialize.min.css"  media="screen,projection"/>
  <link type="text/css" rel="stylesheet" href="/stylesheets/materialize.css">

  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="/javascripts/materialize.js"></script>   
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/0.8.3/angular-material.min.css">

  <!-- HighCharts Library -->
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="http://code.highcharts.com/modules/exporting.js"></script>
    
    

</head>
<body>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-animate.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-aria.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angular_material/0.8.3/angular-material.min.js"></script>

  <div class="navbar-fixed">
    <nav class="grey darken-3 lighten-1" role="navigation">
      <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo">VM Manager</a>
        <ul class="right hide-on-med-and-down">
          <li><a onclick="signOut();">Sign Out</a></li>
        </ul>
        <ul id="nav-mobile" class="side-nav">
          <li><a onclick="signOut();">Sign Out</a></li>
        </ul>
        <a href="#" data-activates="nav-mobile" class="button-collapse"><i class="mdi-navigation-menu"></i></a>
      </div>
    </nav>
  </div>

  <div class="container">
    <div class="section">
      <div class="row">
        <div class="row">
          <div class="col s12">
            <ul class="tabs">
              <!-- <li class="tab col s4"><a class="active" href="#list">List</a></li> -->
              <li class="tab col s6"><a href="#dashboard">Dashboard</a></li>
              <li class="tab col s6"><a href="#launch">Launch Instance</a></li>              
            </ul>
          </div>
          <div id="list" class="col s12">
           
          </div>
          <div id="launch" class="col s12">
            <div class="container">
              <div id="deployVM" class="modal modal-fixed-footer" style="width:30%; height:45%;">
                <div class="modal-content">
                  <h2>Deploy VM</h2>
                  <div class="input-field col s12">    
                    <input id="vmName" type="text" class="validate">
                    <label for="vmName">Name Your VM</label>
                  </div>
                  
                </div>
                <div class="modal-footer">
                  <a class="modal-action modal-close waves-effect waves-green btn-flat" onclick='createVM()'>Create</a>
                  <a href="#" class="modal-action modal-close waves-effect waves-green btn-flat">Close</a>
                </div>
              </div>

              <ul class="collapsible popout" data-collapsible="accordion">
                <li>                  
                  <div class="collapsible-header" data-target="modal1" class="modal-trigger">
                    <span class="col s1">
                    <i class="mdi-hardware-desktop-windows"></i>
                    </span>
                    <span class="col s11">Please select a template from below</span>
                  </div>
                </li>
                <li>
                  <div class="collapsible-header"><i class="mdi-maps-place"></i>Ubuntu</div>
                  <div class="collapsible-body">
                    <div class="row">                      
                      <div class="col s12">
                            <div class="input-field col s12 center">    
                              <h3 class="card-title col s10">Ubuntu - 10GB</h3>
                              <span class="col s2">
                                <div class="btn-floating btn-large waves-effect waves-light red modal-trigger" onclick="openModal('Ubuntu')"><i class="mdi-content-add"></i></div>
                              </span>
                            </div>
                            <div class="divider"></div>
                            <div class="input-field col s12">    
                              <span class="col s4">Type</span><span id="templateType" class="col s8">Plain</span>
                            </div>
                            <div class="input-field col s12">    
                              <span class="col s4">OS</span><span id="templateOS" class="col s8">Ubuntu</span>
                            </div>
                            <div class="input-field col s12">    
                              <span class="col s4">CPU</span><span id="templateCPU" class="col s8">2 core</span>
                            </div>
                            <div class="input-field col s12">    
                              <span class="col s4">Memory</span><span id="templateMemory" class="col s8">2048 MB</span>
                            </div>
                            <div class="input-field col s12">
                              <span class="col s4">Storage Capacity</span><span id="templateCapacity" class="col s8">10 GB</span>
                            </div>
                      </div>
                    </div>
                  </div>
                </li>
                <li>
                  <div class="collapsible-header"><i class="mdi-social-whatshot"></i>Windows</div>
                  <div class="collapsible-body">
                    <div class="row">                      
                      <div class="col s12">
                            <div class="input-field col s12 center">    
                              <h3 class="card-title col s10">Windows - 20GB</h3>
                              <span class="col s2">
                                <div class="btn-floating btn-large waves-effect waves-light red modal-trigger"  onclick="openModal('Windows')"><i class="mdi-content-add"></i></div>
                              </span>
                            </div>
                            <div class="divider"></div>
                            <div class="input-field col s12">    
                              <span class="col s4">Type</span><span id="templateType2" class="col s8">Plain</span>
                            </div>
                            <div class="input-field col s12">    
                              <span class="col s4">OS</span><span id="templateOS2" class="col s8">Windows</span>
                            </div>
                            <div class="input-field col s12">    
                              <span class="col s4">CPU</span><span id="templateCPU2" class="col s8">2 core</span>
                            </div>
                            <div class="input-field col s12">    
                              <span class="col s4">Memory</span><span id="templateMemory2" class="col s8">4096 MB</span>
                            </div>
                            <div class="input-field col s12">
                              <span class="col s4">Storage Capacity</span><span id="templateCapacity2" class="col s8">20 GB</span>
                            </div>
                      </div>
                    </div>
                  </div>
                </li>
              </ul>
              
            </div> 
          </div>
          <div id="dashboard" class="col s12">
            <div class="col s12">
              <!-- Modal Structure -->
              <div id="vmDetails" class="modal modal-fixed-footer" style="width:80%; height:100%">
                <div class="modal-content">

                  <div class="row">                      
                      <div class="col s12">
                            <div class="input-field col s12 center">    
                              <h3 class="card-title" id="vmDetailsHeading"></h3>
                            </div>
                            <div class="divider"></div>
                            <div class="col s4" >                            
                                      <div class="input-field col s12">    
                                        <span class="col s4">OS</span><span id="vmDetailsType" class="col s8"></span>
      </div>
                                      <div class="input-field col s12">    
                                        <span class="col s4">CPU</span><span id="vmDetailsCPU" class="col s8"></span>
      </div>
                                      <div class="input-field col s12">    
                                        <span class="col s4">Memory</span><span id="vmDetailsRam" class="col s8"></span>
      </div>
                                      <div class="input-field col s12">
                                        <span class="col s4">Status</span><span id="vmDetailsStatus" class="col s8"></span>
                                      </div>
                                    </div>
                                  <div class="col s8">
                                    <div id="vmStatsChart" style="margin: 0 auto"></div>
                                  </div>

                      </div>

                    </div>
                </div>
                <div class="modal-footer center">
                  <a class="modal-action modal-close waves-effect waves-green btn-flat" onclick="startStopVM();">Start/Stop</a>
                  <a href="#" class="modal-action modal-close waves-effect waves-green btn-flat">Close</a>
                </div>
              </div>

                <table class="hoverable" id="vmList">
                <thead>
                  <tr>
                      <th data-field="name">VM Name</th>
                      <th data-field="type">Type</th>
                      <th data-field="status">Status</th>
                  </tr>
                </thead>

                <tbody>
                  <!-- <tr data-target="vmDetails" class="modal-trigger">                  
                    <td>VM 1</td>
                    <td>Linux</td>
                    <td>Started</td>
                  </tr>
                   -->
                </tbody>
              </table>
            </div>
          </div>
        </div>        
      </div>
    </div>   
  </div>

  <footer class="page-footer grey darken-3">

<div class="container">
      <div class="row">
        <div class="col l6 s12">
          <h5 class="white-text">TEAM 01</h5>
          <p class="grey-text text-lighten-4">We are a team of college students working on this project like it's our full time job. Any amount would help support and continue development on this project and is greatly appreciated.</p>
        </div>
        <div class="col l6 s12 right-align">
          <h5 class="white-text">Team Members</h5>
          <ul>
            <li><a class="white-text" href="#!">Piyush</a></li>
            <li><a class="white-text" href="#!">Sumit</a></li>
            <li><a class="white-text" href="#!">Vaibhav</a></li>
            <li><a class="white-text" href="#!">Surabhi</a></li>
            <li><a class="white-text" href="#!">Prajakta</a></li>
          </ul>
        </div>
     </div>
    </div>

    <div class="footer-copyright">
      <div class="container">
      Made by <a class="green-text text-lighten-3" href="http://materializecss.com">CmpE 283: Team 01</a>
      </div>
    </div>
  </footer>

  <!--  Scripts-->
  <script type="text/javascript">
  $(document).ready(function(){
     $('.modal-trigger').leanModal();
     getVMList();
  });


  function getVMList(){
  $("#vmList tbody").empty();
   $.get("vm/list", function(res){
      if(!res.type){
          return;
        }else{
                 
          res.data.forEach(function(thisdata){

            var tr = "<tr id=\""+ thisdata.name + "\" onclick=\"openVmDetails(\'" + thisdata.name + "\') \">";
            tr+="<td>"+ thisdata.name +"</td>";
            tr+="<td>"+ thisdata.type+"</td>";
            tr+="<td>"+ thisdata.status +"</td>";
            tr+="</tr>";
            $("#vmList tbody").append(tr);              

            // var tab = document.getElementById("vmList");
            // var row = tab.insertRow();

            // var cell1 = row.insertCell(0);
            // var cell2 = row.insertCell(1);
            // var cell3 = row.insertCell(2);
            // cell1.innerHTML = thisdata.name;
            // cell2.innerHTML = thisdata.type;
            // cell3.innerHTML = thisdata.status;
          });
          sessionStorage.removeItem("instances"); 
          sessionStorage.setItem("instances", JSON.stringify(res.data)); 
      }
    });
}

function signOut(){
  
  console.log("signout");

  $.post("/signout").done(function(res){
    if(!res.type){
      console.log("Please try again.");
    }else{
      window.location.href ="/";
    }
  });
}

function openVmDetails(vmName){
  console.log("openVmDetails(" + vmName +")");
  var instances= JSON.parse(sessionStorage.getItem("instances")); 
  console.log('/vm/' + vmName + '/statistics');
  $.ajax({
     url: '/vm/' + vmName + '/statistics',
     type: 'GET',
     async: true,
     crossDomain: true, // enable this
     dataType: "json",
     cache: false,
     success: function (res) {
       console.log(res.data);
       visitorData(res.data);
     }
   });  
  instances.forEach(function(thisinstance){
    if(thisinstance.name==vmName){
      console.log(thisinstance);
      $('#vmDetailsHeading').text(thisinstance.name);
      $('#vmDetailsType').text(thisinstance.type);
      $('#vmDetailsRam').text(thisinstance.ram);
      $('#vmDetailsCPU').text(thisinstance.cpu);
      $('#vmDetailsStatus').text(thisinstance.status);
    }
    else{
      return;
    }
  });
  $('#vmDetails').openModal();
}

function openModal(templateName){
  console.log(templateName);
  templatenameglobal = templateName;
  $('#deployVM').openModal(); 
}

function createVM(){
  console.log(templatenameglobal);
  var vmName = $('#vmName').val();
  console.log(vmName);

  if(vmName!=""){
    var url = "/vm/" + templatenameglobal + "/create";

    $.ajax({
      type: "POST",
      url: url,
      data: {vmName:vmName},
      dataType: "json",
      timeout: 900000, // in milliseconds
      success: function(res){
            if(!res.type){
              return ;
            }
            else{
              console.log("VM added successfully.");
              getVMList();
            }

      },
      error: function(request, status, err) {
          if(status == "timeout") {
              //gotoDir(pmcat_id, pcat_id);
              console.log("Timeout");
          }
      }
    });
    
    console.log("Adding a VM. It may take a while.");
  }
}

function startStopVM(){
  var url;
  vmName = $('#vmDetailsHeading').html();
  vmStatus = $('#vmDetailsStatus').html();
  console.log(vmName);
  console.log(vmStatus);
  if( vmStatus == 'poweredOn'){
    console.log("Stopping - " + vmName);
    url = "/vm/" + vmName + "/stop";
    $.get(url, function(res){
      if(!res.type){
        return;
      }
      else{
        console.log("VM Stopping. Wait for a while......");
        getVMList();
      }
    });
  }else{
    console.log("Starting - " + vmName);
    url = "/vm/" + vmName + "/start";
    $.get(url, function(res){
      if(!res.type){
        return;
      }
      else{
        console.log("VM Starting. Wait for a while......");
        getVMList();
      }
    });
  }
}

function visitorData (data) {
  console.log(data[0]);
  console.log(data[1]);
  console.log(data[2]);
  //console.log(data[3]);

  $('#vmStatsChart').highcharts({
   
    title: {
      text: 'VM Stats'
    },
    subtitle: {
      text: 'CPU & Memory',
      x: -20
    },
    xAxis: {
      categories: data[0]
    },
    yAxis: {
      
    },
    series:  [{
            name: 'CPU (MHz)',
            data: data[1]
        }, {
            name: 'Memory (MB)',
            data: data[2]
        }]
  });
}

  </script>
  
  </body>
</html>
